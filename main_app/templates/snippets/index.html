{% extends 'base.html' %}

{% block content %}
    <h1 class="h1">SnippetCollector</h1>

    {% comment %} RENDER ALL GROUPS (WITH AT LEAST TWO TAGS) {% endcomment %}
    {% for group in groups %}
        {% if group.tag_set.all.count >= 2 %}
        <div class="card group"> <!--style="display: none"-->
            <div class="card-content">
                <p class="card-title">{{group.name}}</p>
                {% for tag in group.tag_set.all %}
                    <p class="group-tag">{{tag.name}}</p>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    {% endfor %}


    {% comment %} SEARCH BAR {% endcomment %}
    <div style="border: 1px solid black; padding: 5px 10px 0px 10px; background-color: #ffd1d1; margin-bottom: 10px;">
        <form class="form-search">
            <div class="input-field" style="display: flex;">
                <input type="search" class="search autocomplete" placeholder="search through your tags" style="background-color: white;" autofocus>
                <input type="submit" value="Search" style="height: 46px;">
            </div>
        </form>
    </div>

    {% comment %}  {% endcomment %}
    <button class="btn-new-snippet">New Snippet</button>

    {% comment %} NEW SNIPPET (ModelForm) {% endcomment %}
    <div class="card form-new-snippet" style="display: none;">
        <div class="card-content">
            <form method="POST" action="{% url 'new_snippet' %}">
                {% csrf_token %}
                {{snippet_form.as_p}}
                <input type="submit" value="+ snippet">
            </form>
        </div>
    </div>

    {% comment %} RENDER ALL SNIPPETS {% endcomment %}
    <div class="cont-snippets">
        {% for snippet in snippets %}
            <div class="snippet" style="position: relative;">
                {% comment %} RENDER SNIPPET {% endcomment %}
                <textarea class="textarea">{{ snippet.body }}</textarea>

                {% for tag in snippet.tags.all %}
                    {% comment %} RENDER TAG(S) - UNASSOC TAG FORM {% endcomment %}
                    <form method="POST" action="{% url 'unassoc_tag' snippet.id tag.id %}" class="inline-flex">
                        {% csrf_token %}
                        <input type="submit" value="{{tag.name}}" class="tag">
                    </form>
                {% endfor %}

                {% comment %} FIND-OR-CREATE, ASSOC TAG FORM {% endcomment %}
                <form  method="POST" action="{% url 'findOrCreate_assoc_tag' snippet.id %}" class="cont-add-tag">
                    {% csrf_token %}
                    <input type="text" placeholder="some-tag" name="tag" class="tag-input" style="text-transform: lowercase;" required>
                    <input type="submit" value="+ tag" class="add-tag">
                </form>

                {% comment %} DELETE SNIPPET {% endcomment %}
                <form method="POST" action="{% url 'delete_snippet' snippet.id %}" class="inline-flex">
                    {% csrf_token %}
                    <input type="submit" value="DELETE" style="color:salmon; position: absolute; bottom: 5px; right: 5px;">
                </form>

                {% comment %} SCORE (BOTTOM LEFT CORNER) {% endcomment %}
                <div class="score" style="height:14px; width: 10px; background: #fff; border: 1px solid #aaa; position: absolute; bottom: 0; left: 0; font-size: 10px;"></div>
            </div>
        {% endfor %}
    </div>
    
    <div class="spacer"></div>




<script>
console.log('### sanity check ###');
    const snippets = document.querySelectorAll('.snippet')
    const formSearch = document.querySelector('.form-search')
    const autocomplete = document.querySelector('.autocomplete')
    const searchEl = document.querySelector('.search')
    const btnNewSnippet = document.querySelector('.btn-new-snippet')
    const formNewSnippet = document.querySelector('.form-new-snippet')
    const wrapper = document.querySelector('.cont-snippets')


    //get an array of arrays, where each child array contains the tags from each group
    const groupEls = document.querySelectorAll('.group')
    const groups = []
    for (let groupEl of groupEls) {
        //console.log('----group name:-------', groupEl.querySelector('.card-title').textContent)
        const tagsForThisGroup = []
        const tagEls = groupEl.querySelectorAll('.group-tag')
        for (let tagEl of tagEls) {
            //console.log(tagEl.textContent);
            tagsForThisGroup.push(tagEl.textContent)
        }
        groups.push(tagsForThisGroup)
    }
    //console.log('groups:', groups);


    const allTagsOnPage = {}
    for (let snippet of snippets) {
        //reduce height of textarea for snippets with minimal text
        const ta = snippet.querySelector('textarea')
        const ta_length = ta.textContent.length
        if (ta_length < 50) {
            ta.style.height = '25px'
        }

        //add tag to 'allTagsOnPage' as key.  order snippets based on number of tags
        let score = 0
        const tagsOfSnippet = snippet.querySelectorAll('.tag')
        for (let tag of tagsOfSnippet) {
            score++
            allTagsOnPage[tag.getAttribute('value')] = null
        }
        snippet.style.order = score.toString()
        //'allTagsOnPage' is populated
    }
    
    M.Autocomplete.init(autocomplete, {
        data: allTagsOnPage
    })




    formSearch.addEventListener('submit', (e) => {
        e.preventDefault()

        //make wrapper dissappear for a millisecond 
        wrapper.style.opacity = '0'
        setTimeout(() => {
            wrapper.style.opacity = '1'
        }, 40)

        console.log('-------------you submitted thes search form!----------');
        const searchInputStr = spacify3(searchEl.value).toLowerCase()
        let searchInputStrWithGroups = searchInputStr
        //console.log(`searchInputStr:>${ searchInputStr}<`);

        if (searchInputStr == ' ') {
            console.log('ERROR- nothign entered');
            searchEl.value = ''
        }

        //loop through every search tag - if it belongs to a group, then add the tags from that group to the search string 
        const searchInputArr = spacify1(searchEl.value).toLowerCase().split(' ')
        searchInputArr.forEach(searchTag => {
            groups.forEach(group => {
                if (group.indexOf(searchTag) !== -1) {
                    searchInputStrWithGroups +=  group.join(' ') + ' '
                }
            })
        })

        //calculate score for each snippet
        for (let snippet of snippets) {
            const scoreEl = snippet.querySelector('.score')

            let score = 0
            const tags = snippet.querySelectorAll('.tag')
            for (let tag of tags) {
                if (searchInputStrWithGroups.indexOf(tag.getAttribute('value').toLowerCase()) !== -1) {
                    //console.log('found this snippet tag in search string: ', tag.getAttribute('value'));
                    score--
                }
            }
            snippet.style.order = score.toString()

            scoreEl.textContent = (score * -1).toString()
        }
    })

    //click button to toggle visibility of new snippet form 
    btnNewSnippet.addEventListener('click', () => {
        if (formNewSnippet.style.display === 'none') {
            formNewSnippet.style.display = 'block'
            btnNewSnippet.textContent = '^collapse'
            const bodyEl = formNewSnippet.querySelector('textarea')
            bodyEl.focus()
        } else {
            formNewSnippet.style.display = 'none'
            btnNewSnippet.textContent = 'New Snippet'
            searchEl.focus()
        }
        
    })


function spacify3(string) {
    while (string.indexOf('  ') !== -1) {
        string = string.replace('  ',' ')
    }
    let stringSplit = string.split('')
    if (stringSplit[0] !== ' ') {
        stringSplit.unshift(' ')
        string = stringSplit.join('')
    }
    stringSplit = string.split('')
    if (stringSplit[stringSplit.length - 1] !== ' ') {
        stringSplit.push(' ')
        string = stringSplit.join('')
    }
    return string
}

function spacify1(string) {
    while (string.indexOf('  ') !== -1) {
        string = string.replace('  ',' ')
    }
    let stringSplit = string.split('')
    if (stringSplit[0] === ' ') {
        stringSplit.shift(' ')
        string = stringSplit.join('')
    }
    stringSplit = string.split('')
    if (stringSplit[stringSplit.length - 1] === ' ') {
        stringSplit.pop(' ')
        string = stringSplit.join('')
    }
    return string

}
</script>


{% endblock content %}
